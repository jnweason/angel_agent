<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Angel Agent</title>
    
    <!-- PWA åŸºç¤è¨­å®š -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0088cc">
    
    <!-- iOS å°ˆå±¬è¨­å®š (é—œéµï¼) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Angel Agent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        /* CSS Reset èˆ‡ RWD è¨­å®š */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; 
            background: #f0f2f5; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            height: 100dvh; /* å‹•æ…‹è¦–çª—é«˜åº¦ï¼Œä¿®æ­£ iOS Safari çš„ 100vh å•é¡Œ */
            overflow: hidden; /* é˜²æ­¢æ•´é æ»¾å‹• */
        }

        /* é ‚éƒ¨å°èˆªåˆ— */
        .header { 
            background: #0088cc; 
            color: white; 
            padding: 15px; 
            text-align: center; 
            font-weight: bold; 
            font-size: 18px;
            flex-shrink: 0;
            padding-top: max(15px, env(safe-area-inset-top)); /* é©æ‡‰ iPhone åŠ‰æµ· */
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* ç™»å…¥æ¡† */
        .login-box { 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            height: 100%; 
        }
        
        input[type="text"], input[type="password"] { 
            width: 100%; 
            padding: 15px; 
            margin-bottom: 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
        }
        
        button { 
            padding: 15px; 
            background: #0088cc; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:active { background: #006699; } /* è§¸æ§å›é¥‹ */

        /* API è³‡è¨Šåˆ— */
        .api-info { 
            background: #fffbe6; 
            padding: 10px 15px; 
            font-size: 12px; 
            border-bottom: 1px solid #ffe58f; 
            word-break: break-all;
            flex-shrink: 0;
        }

        /* èŠå¤©å€åŸŸ */
        .chat-box { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            background: #e5ddd5; /* é¡ä¼¼ WhatsApp èƒŒæ™¯ */
            -webkit-overflow-scrolling: touch; /* iOS å¹³æ»‘æ»¾å‹• */
        }

        /* è¨Šæ¯æ³¡æ³¡ */
        .msg { 
            padding: 10px 15px; 
            border-radius: 15px; 
            max-width: 80%; 
            word-wrap: break-word; 
            font-size: 16px;
            line-height: 1.4;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .msg.user { 
            background: #dcf8c6; 
            align-self: flex-end; 
            border-bottom-right-radius: 2px;
        }
        .msg.external { 
            background: white; 
            align-self: flex-start; 
            border-bottom-left-radius: 2px;
        }

        /* åº•éƒ¨è¼¸å…¥å€ */
        .input-area { 
            display: flex; 
            padding: 10px; 
            background: #f0f0f0; 
            border-top: 1px solid #ddd;
            align-items: center;
            padding-bottom: max(10px, env(safe-area-inset-bottom)); /* é©æ‡‰ iPhone Home Bar */
            flex-shrink: 0;
        }
        
        .input-area input { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 20px; 
            background: white; 
            font-size: 16px; 
            outline: none;
        }
        
        .input-area button { 
            margin-left: 8px; 
            padding: 8px 15px;
            border-radius: 50%; 
            width: 44px; 
            height: 44px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            padding: 0;
        }
        
        /* éš±è—æ»¾å‹•æ¢ (ç¾è§€) */
        .chat-box::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body>

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginScreen" class="login-box">
        <h2 style="text-align:center; color: #0088cc;">Angel Agent</h2>
        <input type="text" id="username" placeholder="å¸³è™Ÿ">
        <input type="password" id="password" placeholder="å¯†ç¢¼">
        <button onclick="register()">è¨»å†Šæ–°å¸³è™Ÿ</button>
        <button onclick="login()" style="background: #4CAF50; margin-top: 10px;">ç™»å…¥</button>
    </div>

    <!-- ä¸»ç•«é¢ -->
    <div id="mainScreen" style="display:none; flex-direction: column; height: 100%;">
        <div class="header">Angel Agent</div>
        <div class="api-info">
            ğŸ”‘ ä½ çš„ API Key: <span id="apiKeyDisplay">è¼‰å…¥ä¸­...</span>
        </div>
        
        <div id="chatBox" class="chat-box"></div>
        
        <div class="input-area">
            <input type="text" id="msgInput" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key === 'Enter') sendMessage()">
            <button onclick="startVoice()" style="background:#ff9800; font-size: 20px;">ğŸ¤</button>
            <button onclick="sendMessage()" style="background:#0088cc;">â¤</button>
        </div>
    </div>

    <script>
        const API_URL = ''; // å› ç‚ºæ˜¯åŒæºï¼Œç•™ç©ºå³å¯
        let currentUser = null;
        let recognition = null;
        let lastSpokenId = 0;

        // --- PWA Service Worker è¨»å†Š ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.error('SW registration failed:', err));
            });
        }

        // --- èªéŸ³è¾¨è­˜è¨­å®š ---
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (window.SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'zh-TW';
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('msgInput').value = text;
                sendMessage();
            };
        }

        function startVoice() {
            if(recognition) recognition.start();
            else alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥');
        }

        // --- å¸³è™Ÿç³»çµ± ---
        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if(!username || !password) return alert('è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼');
            
            const res = await fetch(`${API_URL}/api/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });
            const data = await res.json();
            if(data.success) alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥ã€‚');
            else alert(data.message);
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const res = await fetch(`${API_URL}/api/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });
            const data = await res.json();
            if(data.success) {
                currentUser = {id: data.userId, apiKey: data.apiKey};
                localStorage.setItem('angelUser', JSON.stringify(currentUser)); // è¨˜ä½ç™»å…¥ç‹€æ…‹
                showMainScreen();
            } else {
                alert('ç™»å…¥å¤±æ•—');
            }
        }

        function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'flex';
            document.getElementById('apiKeyDisplay').innerText = currentUser.apiKey;
            loadMessages();
            setInterval(loadMessages, 3000);
        }

        // --- è¨Šæ¯ç³»çµ± ---
        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value;
            if(!text) return;
            
            addMessageToUI(text, 'user');
            
            try {
                await fetch(`${API_URL}/api/user-message`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        userId: currentUser.id,
                        message: text
                    })
                });
            } catch (err) {
                console.error('ç™¼é€å¤±æ•—', err);
            }
            input.value = '';
        }

        async function loadMessages() {
            if(!currentUser) return;
            try {
                const res = await fetch(`${API_URL}/api/messages/${currentUser.id}`);
                const messages = await res.json();
                const box = document.getElementById('chatBox');
                box.innerHTML = '';
                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `msg ${msg.sender}`;
                    div.innerText = msg.content;
                    box.appendChild(div);
                });
                
                // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
                box.scrollTop = box.scrollHeight;

                if(messages.length > 0) {
                    const lastMsg = messages[messages.length-1];
                    if (lastMsg.sender === 'external' && lastMsg.id > lastSpokenId) {
                        speak(lastMsg.content);
                        lastSpokenId = lastMsg.id;
                    }
                }
            } catch(e) {
                console.log("è¼‰å…¥è¨Šæ¯å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç¶²è·¯å•é¡Œ");
            }
        }

        function addMessageToUI(text, sender) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            speechSynthesis.speak(utterance);
        }

        // --- è‡ªå‹•ç™»å…¥æª¢æŸ¥ ---
        const savedUser = localStorage.getItem('angelUser');
        if(savedUser) {
            currentUser = JSON.parse(savedUser);
            showMainScreen();
        }
    </script>
</body>
</html>
